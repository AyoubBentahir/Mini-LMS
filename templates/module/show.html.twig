{% extends 'base.html.twig' %}

{% block title %}{{ module.title }}{% endblock %}

{% block body %}
<main class="main-area">
    <div class="course-view-header">
        <div class="header-breadcrumb">
            <a href="{{ path('app_module_index') }}" class="breadcrumb-link">
                <i class="fas fa-arrow-left"></i> Retour aux modules
            </a>
        </div>
        
        <div class="header-title-section">
            <div class="course-title-wrapper">
                <div class="course-view-icon">
                    <i class="fas fa-layer-group"></i>
                </div>
                
                <div class="course-title-info">
                    <h1>{{ module.title }}</h1>
                </div>
            </div>
            
            <div class="course-actions-group">
                <a href="{{ path('app_resource_new', {'module_id': module.id}) }}" class="btn-action-primary">
                    <i class="fas fa-plus"></i> Ajouter une ressource
                </a>
                <button type="button" class="btn-action-danger" onclick="document.getElementById('deleteForm').style.display='flex'">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>

    <div class="course-view-grid">
        <div class="course-main-content">
            <div class="info-card">
                <div class="info-card-header">
                    <h2><i class="fas fa-info-circle"></i> Informations du module</h2>
                </div>
                <div class="info-card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Cours associé</span>
                            <div class="course-badge-info">
                                <i class="fas fa-book"></i>
                                <span>{{ module.course ? module.course.title : 'Non assigné' }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ordre d'affichage</span>
                            <div class="order-badge">
                                <i class="fas fa-sort-numeric-up"></i>
                                <span>{{ module.orderIndex }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <div class="info-card-header">
                    <h2><i class="fas fa-file-alt"></i> Ressources du module</h2>
                    <span class="badge-count">{{ module.resources|length }}</span>
                </div>
                <div class="info-card-body">
                    {% if module.resources|length > 0 %}
                        <div class="modules-list">
                            {% for resource in module.resources %}
                                <div class="module-item">
                                    <div class="module-number">{{ loop.index }}</div>
                                    <div class="module-details module-details-clickable">
                                        {% if resource.type == 'file' and resource.content %}
                                            <a href="{{ resource.content }}" target="_blank" class="resource-link" download>
                                                <h4>{{ resource.title }}</h4>
                                                <span class="module-resources">
                                                    <i class="fas fa-file-download"></i>
                                                    Fichier - Cliquez pour télécharger
                                                </span>
                                            </a>
                                        {% elseif resource.type == 'link' and resource.content %}
                                            <a href="{{ resource.content }}" target="_blank" class="resource-link">
                                                <h4>{{ resource.title }}</h4>
                                                <span class="module-resources">
                                                    <i class="fas fa-external-link-alt"></i>
                                                    Lien externe - Cliquez pour ouvrir
                                                </span>
                                            </a>
                                        {% elseif resource.type == 'text' %}
                                            <div class="resource-text-preview" onclick="openTextModal{{ resource.id }}()">
                                                <h4>{{ resource.title }}</h4>
                                                <span class="module-resources">
                                                    <i class="fas fa-align-left"></i>
                                                    Texte - Cliquez pour lire
                                                </span>
                                            </div>
                                        {% else %}
                                            <h4>{{ resource.title }}</h4>
                                            <span class="module-resources">
                                                <i class="fas fa-file"></i>
                                                {{ resource.type|default('Document') }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn-resource-delete" title="Supprimer" onclick="openDeleteModalResource{{ resource.id }}()">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                
                                {% if resource.type == 'text' %}
                                    <!-- Text Modal for resource {{ resource.id }} -->
                                    <div id="textModal{{ resource.id }}" class="delete-modal-overlay" style="display: none;">
                                        <div class="delete-modal-content" style="max-width: 700px;">
                                            <div class="delete-modal-header">
                                                <h3><i class="fas fa-align-left"></i> {{ resource.title }}</h3>
                                                <button onclick="closeTextModal{{ resource.id }}()" class="close-modal">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="delete-modal-body">
                                                <div style="white-space: pre-wrap; line-height: 1.8;">{{ resource.content }}</div>
                                            </div>
                                            <div class="delete-modal-footer">
                                                <button onclick="closeTextModal{{ resource.id }}()" class="btn-cancel-modal">
                                                    Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <script>
                                        function openTextModal{{ resource.id }}() {
                                            document.getElementById('textModal{{ resource.id }}').style.display = 'flex';
                                        }
                                        function closeTextModal{{ resource.id }}() {
                                            document.getElementById('textModal{{ resource.id }}').style.display = 'none';
                                        }
                                    </script>
                                {% endif %}
                                
                                <!-- Delete Modal for resource {{ resource.id }} -->
                                <div id="deleteModalResource{{ resource.id }}" class="delete-modal-overlay" style="display: none;">
                                    <div class="delete-modal-content">
                                        <div class="delete-modal-header">
                                            <h3><i class="fas fa-exclamation-triangle"></i> Confirmer la suppression</h3>
                                            <button onclick="closeDeleteModalResource{{ resource.id }}()" class="close-modal">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="delete-modal-body">
                                            <p>Êtes-vous sûr de vouloir supprimer la ressource <strong>{{ resource.title }}</strong> ?</p>
                                            <p class="warning-text">Cette action est irréversible.</p>
                                        </div>
                                        <div class="delete-modal-footer">
                                            <button onclick="closeDeleteModalResource{{ resource.id }}()" class="btn-cancel-modal">
                                                Annuler
                                            </button>
                                            <form method="post" action="{{ path('app_resource_delete', {'id': resource.id}) }}" style="display: inline;">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ resource.id) }}">
                                                <button type="submit" class="btn-delete-confirm">
                                                    <i class="fas fa-trash"></i> Supprimer
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <script>
                                    function openDeleteModalResource{{ resource.id }}() {
                                        document.getElementById('deleteModalResource{{ resource.id }}').style.display = 'flex';
                                    }
                                    function closeDeleteModalResource{{ resource.id }}() {
                                        document.getElementById('deleteModalResource{{ resource.id }}').style.display = 'none';
                                    }
                                </script>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-modules">
                            <i class="fas fa-file-alt"></i>
                            <p>Aucune ressource créée pour ce module</p>
                            <a href="{{ path('app_resource_new') }}" class="btn-add-module">
                                Ajouter une ressource
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteForm" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" onclick="if(event.target === this) this.style.display='none'">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 20px;"></i>
            <h2 style="margin-bottom: 15px; color: #1e293b;">Confirmer la suppression</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Êtes-vous sûr de vouloir supprimer ce module ? Cette action est irréversible.</p>
            {{ include('module/_delete_form.html.twig') }}
            <button onclick="document.getElementById('deleteForm').style.display='none'" style="margin-left: 10px; padding: 12px 24px; background: white; border: 1px solid #e2e8f0; border-radius: 30px; font-weight: 600; cursor: pointer;">Annuler</button>
        </div>
    </div>
</main>
{% endblock %}
