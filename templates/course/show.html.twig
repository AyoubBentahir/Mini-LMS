{% extends 'base.html.twig' %}

{% block title %}{{ course.title }}{% endblock %}

{% block body %}
<main class="main-area">
    <div class="course-view-header">
        <div class="header-breadcrumb">
            <a href="{{ path('app_course_index') }}" class="breadcrumb-link">
                <i class="fas fa-arrow-left"></i> Retour aux cours
            </a>
        </div>
        
        <div class="header-title-section">
            <div class="course-title-wrapper">
                {% set title_lower = course.title|lower %}
                
                {# Smart Icon Detection #}
                {% if 'math' in title_lower or 'mathématique' in title_lower or 'algèbre' in title_lower or 'géométrie' in title_lower %}
                    {% set icon = 'fa-calculator' %}
                    {% set badge_class = 'math' %}
                    {% set badge_text = 'MATHÉMATIQUES' %}
                {% elseif 'code' in title_lower or 'programmation' in title_lower or 'développement' in title_lower or 'web' in title_lower or 'python' in title_lower or 'javascript' in title_lower or 'php' in title_lower %}
                    {% set icon = 'fa-code' %}
                    {% set badge_class = 'code' %}
                    {% set badge_text = 'PROGRAMMATION' %}
                {% elseif 'design' in title_lower or 'graphique' in title_lower or 'ui' in title_lower or 'ux' in title_lower %}
                    {% set icon = 'fa-palette' %}
                    {% set badge_class = 'design' %}
                    {% set badge_text = 'DESIGN' %}
                {% elseif 'data' in title_lower or 'données' in title_lower or 'analyse' in title_lower or 'statistique' in title_lower %}
                    {% set icon = 'fa-chart-line' %}
                    {% set badge_class = 'data' %}
                    {% set badge_text = 'DATA SCIENCE' %}
                {% elseif 'marketing' in title_lower or 'communication' in title_lower %}
                    {% set icon = 'fa-bullhorn' %}
                    {% set badge_class = 'marketing' %}
                    {% set badge_text = 'MARKETING' %}
                {% elseif 'science' in title_lower or 'physique' in title_lower or 'chimie' in title_lower or 'biologie' in title_lower %}
                    {% set icon = 'fa-flask' %}
                    {% set badge_class = 'science' %}
                    {% set badge_text = 'SCIENCES' %}
                {% elseif 'langue' in title_lower or 'anglais' in title_lower or 'français' in title_lower or 'espagnol' in title_lower %}
                    {% set icon = 'fa-language' %}
                    {% set badge_class = 'language' %}
                    {% set badge_text = 'LANGUES' %}
                {% elseif 'histoire' in title_lower or 'géographie' in title_lower %}
                    {% set icon = 'fa-globe' %}
                    {% set badge_class = 'history' %}
                    {% set badge_text = 'HISTOIRE-GÉO' %}
                {% else %}
                    {% set icon = 'fa-book' %}
                    {% set badge_class = 'general' %}
                    {% set badge_text = 'GÉNÉRAL' %}
                {% endif %}
                
                <div class="course-view-icon">
                    <i class="fas {{ icon }}"></i>
                </div>
                
                <div class="course-title-info">
                    <h1>{{ course.title }}</h1>
                </div>
            </div>
            
            <div class="course-actions-group">
                <a href="{{ path('app_course_edit', {'id': course.id}) }}" class="btn-edit">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <button type="button" class="btn-action-danger" onclick="document.getElementById('deleteForm').style.display='flex'">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    </div>

    <div class="course-view-grid">
        <div class="course-main-content">
            <div class="info-card">
                <div class="info-card-header">
                    <h2><i class="fas fa-info-circle"></i> Informations du cours</h2>
                </div>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Description</span>
                        <p class="info-value">{{ course.description|default('Aucune description disponible') }}</p>
                    </div>
                    
                    <div class="info-row-grid">
                        <div class="info-item">
                            <span class="info-label">Code unique</span>
                            <div class="code-badge">
                                <i class="fas fa-hashtag"></i>
                                <span>{{ course.codeUnique }}</span>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Date de création</span>
                            <div class="date-badge">
                                <i class="fas fa-calendar"></i>
                                <span>{{ course.createdAt ? course.createdAt|date('d/m/Y') : 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <div class="info-card-header">
                    <h2><i class="fas fa-layer-group"></i> Modules du cours</h2>
                    <span class="badge-count">{{ course.modules|length }}</span>
                </div>
                <div class="info-card-body">
                    {% if course.modules|length > 0 %}
                        <div class="modules-list">
                            {% for module in course.modules %}
                                <div class="module-item">
                                    <div class="module-number">{{ loop.index }}</div>
                                    <div class="module-details">
                                        <h4>{{ module.title }}</h4>
                                        <span class="module-resources">
                                            <i class="fas fa-file-alt"></i>
                                            {{ module.resources|length }} ressources
                                        </span>
                                    </div>
                                    <a href="{{ path('app_module_show', {'id': module.id}) }}" class="btn-module-view">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-modules">
                            <i class="fas fa-layer-group"></i>
                            <p>Aucun module créé pour ce cours</p>
                            <a href="{{ path('app_module_new') }}" class="btn-add-module">
                                Ajouter un module
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="course-sidebar-info">
            <div class="stats-card">
                <h3><i class="fas fa-users"></i> Étudiants</h3>
                <p class="sidebar-subtitle">Liste des étudiants ayant consulté ce cours</p>
                
                {% if students|length > 0 %}
                    <div class="students-list" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                        {% for item in students %}
                            {% set student = item.user %}
                            <div class="student-item" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 12px; background: #f8fafc; border: 1px solid #e2e8f0;">
                                <div class="student-avatar">
                                    <img src="https://ui-avatars.com/api/?name={{ student.prenom }}+{{ student.nom }}&background=random&color=fff&size=40" 
                                         alt="{{ student.prenom }}" 
                                         style="width: 40px; height: 40px; border-radius: 50%;">
                                </div>
                                <div class="student-info" style="display: flex; flex-direction: column;">
                                    <span class="student-name" style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">
                                        {{ student.prenom }} {{ student.nom }}
                                    </span>
                                    <span class="student-date" style="font-size: 0.75rem; color: #64748b;">
                                        Inscrit le {{ item.enrolledAt|date('d/m/Y') }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                     <div class="empty-state" style="text-align: center; padding: 20px; color: #94a3b8;">
                        <i class="fas fa-user-graduate" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p style="font-size: 0.9rem;">Aucun étudiant inscrit pour le moment.</p>
                     </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="deleteForm" class="delete-modal-overlay" style="display: none;" onclick="if(event.target === this) this.style.display='none'">
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Confirmer la suppression</h3>
            </div>
            <div class="delete-modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ce cours ? Cette action est irréversible.</p>
            </div>
            <div class="delete-modal-footer">
                {{ include('course/_delete_form.html.twig') }}
                <button onclick="document.getElementById('deleteForm').style.display='none'" class="btn-cancel-modal">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</main>
{% endblock %}
