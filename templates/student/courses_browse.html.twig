{% extends 'base.html.twig' %}

{% block title %}Catalogue des Cours{% endblock %}

{% block body %}
<main class="dashboard-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header & Tools -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Catalogue des Cours</h1>
            <p class="text-gray-500 mt-1">Découvrez et inscrivez-vous aux cours qui vous intéressent.</p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
            <!-- Search -->
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="courseSearch" placeholder="Rechercher un cours..." 
                       class="w-full sm:w-64 pl-11 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-sm">
            </div>
            
            <!-- Filters -->
            <div class="bg-white p-1 rounded-xl border border-gray-200 inline-flex shadow-sm">
                <button class="filter-btn active px-4 py-1.5 rounded-lg text-sm font-bold transition-all bg-gray-100 text-gray-900" data-filter="all">Tout</button>
                <button class="filter-btn px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-50 transition-all" data-filter="available">Disponibles</button>
                <button class="filter-btn px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-50 transition-all" data-filter="enrolled">Inscrits</button>
            </div>
        </div>
    </div>

    {% if courses|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="coursesGrid">
            {% for course in courses %}
                {% set is_enrolled = course.id in enrolled_course_ids %}
                {% set title_lower = course.title|lower %}
                
                {# Smart Icon Detection #}
                {% if 'math' in title_lower %} {% set icon = 'calculator' %} {% set badge_color = 'blue' %}
                {% elseif 'code' in title_lower or 'dev' in title_lower or 'sym' in title_lower or 'php' in title_lower or 'java' in title_lower or 'c++' in title_lower or 'c#' in title_lower or 'python' in title_lower or 'sql' in title_lower or 'web' in title_lower or 'html' in title_lower or 'css' in title_lower or 'js' in title_lower %} {% set icon = 'code' %} {% set badge_color = 'indigo' %}
                {% elseif 'design' in title_lower or 'art' in title_lower or 'adobe' in title_lower %} {% set icon = 'palette' %} {% set badge_color = 'pink' %}
                {% elseif 'data' in title_lower or 'analy' in title_lower %} {% set icon = 'database' %} {% set badge_color = 'emerald' %}
                {% else %} {% set icon = 'book-open' %} {% set badge_color = 'violet' %}
                {% endif %}

                <article class="course-card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300 flex flex-col h-full group transform hover:-translate-y-1"
                         data-title="{{ course.title|lower }}"
                         data-enrolled="{{ is_enrolled ? 'true' : 'false' }}">
                    
                    <div class="h-44 bg-gradient-to-br from-{{ badge_color }}-50 to-white relative flex items-center justify-center overflow-hidden">
                        <div class="absolute w-64 h-64 bg-{{ badge_color }}-100/50 rounded-full blur-3xl -top-10 -right-10 group-hover:bg-{{ badge_color }}-200/50 transition-colors duration-500"></div>
                        
                        <i class="fas fa-{{ icon }} text-7xl text-{{ badge_color }}-300 group-hover:text-{{ badge_color }}-400 transition-colors transform group-hover:scale-110 duration-500 relative z-10 drop-shadow-sm"></i>
                        
                        <div class="absolute top-4 right-4 z-20">
                            {% if is_enrolled %}
                                <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full uppercase tracking-wide border border-green-200 flex items-center gap-1 shadow-sm">
                                    <i class="fas fa-check"></i> Inscrit
                                </span>
                            {% else %}
                                <span class="px-3 py-1 bg-white/90 backdrop-blur-md text-{{ badge_color }}-600 text-xs font-bold rounded-full uppercase tracking-wide shadow-sm border border-{{ badge_color }}-100">
                                    {{ course.category|default('Cours') }}
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="p-6 flex-1 flex flex-col">
                        <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-indigo-600 transition-colors line-clamp-2" title="{{ course.title }}">
                            {{ course.title }}
                        </h3>
                        
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2 flex-1">
                            {{ course.description|default('Aucune description disponible.') }}
                        </p>
                        
                        <div class="flex items-center gap-4 text-xs text-gray-500 mb-4 pb-4 border-b border-gray-50">
                            <span class="flex items-center">
                                <i class="fas fa-layer-group mr-1 text-{{ badge_color }}-500"></i> 
                                {{ course.modules|length }} modules
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-user-tie mr-1 text-{{ badge_color }}-500"></i> 
                                {{ course.teacher.prenom }} {{ course.teacher.nom }}
                            </span>
                        </div>

                        <div class="mt-auto flex gap-2">
                            <a href="{{ path('app_student_course_view', {'id': course.id}) }}" 
                               class="flex-1 px-4 py-2.5 rounded-lg bg-gray-50 text-gray-700 font-bold text-sm hover:bg-gray-100 transition-all shadow-sm text-center">
                                <i class="fas fa-eye mr-1"></i> Voir
                            </a>
                            
                            {% if not is_enrolled %}
                                <form action="{{ path('app_student_course_enroll', {'id': course.id}) }}" method="post" class="flex-1">
                                    <button type="submit" 
                                            class="w-full px-4 py-2.5 rounded-lg bg-{{ badge_color }}-600 text-white font-bold text-sm hover:bg-{{ badge_color }}-700 transition-all shadow-sm">
                                        <i class="fas fa-plus-circle mr-1"></i> S'inscrire
                                    </button>
                                </form>
                            {% else %}
                                <a href="{{ path('app_student_course_view', {'id': course.id}) }}" 
                                   class="flex-1 px-4 py-2.5 rounded-lg bg-green-600 text-white font-bold text-sm hover:bg-green-700 transition-all shadow-sm text-center">
                                    <i class="fas fa-play-circle mr-1"></i> Continuer
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </article>
            {% endfor %}
        </div>
        
        <!-- Empty State for filtered results -->
        <div id="noResults" class="hidden text-center py-12">
            <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                <i class="fas fa-search-minus text-2xl"></i>
            </div>
            <p class="text-gray-500 font-medium">Aucun cours ne correspond à votre recherche.</p>
        </div>

    {% else %}
        <div class="text-center py-16 bg-white rounded-2xl border-2 border-dashed border-gray-200">
            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-book-open text-indigo-200 text-4xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Aucun cours disponible</h3>
            <p class="text-gray-500 max-w-md mx-auto">Les enseignants n'ont pas encore créé de cours. Revenez plus tard.</p>
        </div>
    {% endif %}
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('courseSearch');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const courseCards = document.querySelectorAll('.course-card');
        const noResults = document.getElementById('noResults');

        let currentFilter = 'all';
        let currentSearch = '';

        // Filter Logic
        function filterCourses() {
            let visibleCount = 0;

            courseCards.forEach(card => {
                const title = card.dataset.title;
                const isEnrolled = card.dataset.enrolled === 'true';
                
                const matchesSearch = title.includes(currentSearch);
                let matchesFilter = true;
                
                if (currentFilter === 'enrolled') {
                    matchesFilter = isEnrolled;
                } else if (currentFilter === 'available') {
                    matchesFilter = !isEnrolled;
                }

                if (matchesSearch && matchesFilter) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show empty state if no results found
            if (visibleCount === 0 && courseCards.length > 0) {
                noResults.classList.remove('hidden');
            } else if (noResults) {
                noResults.classList.add('hidden');
            }
        }

        // Search Event
        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value.toLowerCase().trim();
                filterCourses();
            });
        }

        // Button Events
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update UI
                filterBtns.forEach(b => {
                    b.classList.remove('active', 'bg-gray-100', 'text-gray-900');
                    b.classList.add('text-gray-500', 'hover:bg-gray-50');
                });
                btn.classList.add('active', 'bg-gray-100', 'text-gray-900');
                btn.classList.remove('text-gray-500', 'hover:bg-gray-50');

                // Update Logic
                currentFilter = btn.dataset.filter;
                filterCourses();
            });
        });
    });
</script>
{% endblock %}
